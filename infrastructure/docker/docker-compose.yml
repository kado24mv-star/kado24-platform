version: '3.8'
name: Infrastructure
services:
  # ============================================
  # Redis Cache
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: kado24-redis
    command: redis-server --requirepass kado24_redis_pass --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - kado24-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # ============================================
  # etcd for APISIX
  # ============================================
  etcd:
    image: quay.io/coreos/etcd:v3.5.9
    container_name: kado24-etcd
    command:
      - etcd
      - --advertise-client-urls=http://0.0.0.0:2379
      - --listen-client-urls=http://0.0.0.0:2379
    ports:
      - "2379:2379"
      - "2380:2380"
    volumes:
      - etcd_data:/bitnami/etcd
    networks:
      - kado24-network
    restart: unless-stopped

  # ============================================
  # Apache APISIX API Gateway
  # ============================================
  apisix:
    image: apache/apisix:3.7.0-debian
    container_name: kado24-apisix
    depends_on:
      - etcd
    ports:
      - "9080:9080"    # HTTP
      - "9091:9091"    # Admin API
      - "9443:9443"    # HTTPS
    volumes:
      - ../../gateway/apisix/config.yaml:/usr/local/apisix/conf/config.yaml:ro
      # - ../../gateway/apisix/logs:/usr/local/apisix/logs  # Commented out due to Windows permission issues
    networks:
      - kado24-network
    restart: unless-stopped

  # ============================================
  # Redis Commander - Redis Management UI
  # ============================================
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: kado24-redis-commander
    depends_on:
      - redis
    ports:
      - "8090:8081"
    environment:
      REDIS_HOSTS: local:redis:6379:0:kado24_redis_pass
    networks:
      - kado24-network
    restart: unless-stopped

# ============================================
# Volumes
# ============================================
volumes:
  redis_data:
    name: kado24_redis_data
  etcd_data:
    name: kado24_etcd_data

# ============================================
# Networks
# ============================================
networks:
  kado24-network:
    name: kado24-network
    driver: bridge

