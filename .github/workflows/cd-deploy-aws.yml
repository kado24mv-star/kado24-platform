name: CD - Deploy to AWS

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com

jobs:
  build-and-push-images:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    strategy:
      matrix:
        service:
          - auth-service
          - user-service
          - voucher-service
          - order-service
          - wallet-service
          - redemption-service
          - merchant-service
          - admin-portal-backend
          - notification-service
          - payout-service
          - analytics-service
          - mock-payment-service
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
      
      - name: Build shared libraries
        run: |
          cd backend/shared/common-lib && mvn clean install -DskipTests
          cd ../security-lib && mvn clean install -DskipTests
          cd ../kafka-lib && mvn clean install -DskipTests
      
      - name: Build ${{ matrix.service }}
        run: |
          cd backend/services/${{ matrix.service }}
          mvn clean package -DskipTests
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Build, tag, and push image
        env:
          ECR_REPOSITORY: kado24/${{ matrix.service }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          cd backend/services/${{ matrix.service }}
          docker build -t $ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker tag $ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

  deploy-to-ecs:
    name: Deploy to ECS
    needs: build-and-push-images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Update ECS service
        run: |
          SERVICES=(
            "auth-service:8081"
            "user-service:8082"
            "voucher-service:8083"
            "order-service:8084"
            "wallet-service:8086"
            "redemption-service:8087"
            "merchant-service:8088"
            "admin-portal-backend:8089"
            "notification-service:8091"
            "payout-service:8092"
            "analytics-service:8093"
            "mock-payment-service:8095"
          )
          
          CLUSTER_NAME="kado24-cluster"
          ENVIRONMENT="${{ github.event.inputs.environment || 'staging' }}"
          
          for SERVICE_INFO in "${SERVICES[@]}"; do
            IFS=':' read -r SERVICE_NAME PORT <<< "$SERVICE_INFO"
            SERVICE_NAME_FULL="kado24-$SERVICE_NAME"
            
            echo "Updating service: $SERVICE_NAME_FULL"
            
            aws ecs update-service \
              --cluster $CLUSTER_NAME \
              --service $SERVICE_NAME_FULL \
              --force-new-deployment \
              --region ${{ env.AWS_REGION }} || echo "Service $SERVICE_NAME_FULL may not exist yet"
          done
      
      - name: Wait for deployment
        run: |
          SERVICES=(
            "auth-service"
            "user-service"
            "voucher-service"
            "order-service"
            "wallet-service"
            "redemption-service"
            "merchant-service"
            "admin-portal-backend"
            "notification-service"
            "payout-service"
            "analytics-service"
            "mock-payment-service"
          )
          
          CLUSTER_NAME="kado24-cluster"
          
          for SERVICE_NAME in "${SERVICES[@]}"; do
            SERVICE_NAME_FULL="kado24-$SERVICE_NAME"
            echo "Waiting for $SERVICE_NAME_FULL to stabilize..."
            
            aws ecs wait services-stable \
              --cluster $CLUSTER_NAME \
              --services $SERVICE_NAME_FULL \
              --region ${{ env.AWS_REGION }} || echo "Service $SERVICE_NAME_FULL not found"
          done

  deploy-frontend:
    name: Deploy Frontend to S3
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    strategy:
      matrix:
        app:
          - admin-portal
          - consumer-app
          - merchant-app
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Node.js (for admin-portal)
        if: matrix.app == 'admin-portal'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/admin-portal/package-lock.json
      
      - name: Setup Flutter (for Flutter apps)
        if: matrix.app != 'admin-portal'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'
      
      - name: Build admin-portal
        if: matrix.app == 'admin-portal'
        run: |
          cd frontend/admin-portal
          npm ci
          npm run build -- --configuration production
      
      - name: Build Flutter app
        if: matrix.app != 'admin-portal'
        run: |
          cd frontend/${{ matrix.app }}
          flutter pub get
          flutter build web --release
      
      - name: Deploy to S3
        env:
          S3_BUCKET: ${{ matrix.app == 'admin-portal' && 'kado24-admin-portal' || format('kado24-%s', matrix.app) }}
        run: |
          if [ "${{ matrix.app }}" == "admin-portal" ]; then
            aws s3 sync frontend/admin-portal/dist/admin-portal s3://$S3_BUCKET --delete
          else
            aws s3 sync frontend/${{ matrix.app }}/build/web s3://$S3_BUCKET --delete
          fi
      
      - name: Invalidate CloudFront
        env:
          CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DIST_ID_${{ matrix.app }} }}
        run: |
          if [ -n "$CLOUDFRONT_DISTRIBUTION_ID" ]; then
            aws cloudfront create-invalidation \
              --distribution-id $CLOUDFRONT_DISTRIBUTION_ID \
              --paths "/*"
          fi

